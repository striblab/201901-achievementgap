---
title: "BasicSkillsAnalysis_v2"
author: "MaryJoWebster"
date: "February 27, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


```

```{r, code=readLines("build_data.R"), echo=FALSE, warning=FALSE, message=FALSE}


```

#All schools that generated revenue & spent money
(need to adjust if we get better data)
```{r}
match2018 <-  match2018 %>% mutate(diff=round_half_up(rev_per_need-spend_per_need))

pov_level_spending <- match2018 %>% filter(district_type=='01' | district_type=='03', revenue>0, tot_spent>0) %>% group_by(poverty_level) %>% summarise(avgrev= mean(rev_per_need),avgspend = mean(spend_per_need))


pov_level_spending_melt <-  melt(pov_level_spending, id.vars="poverty_level")

pov_level_spending_melt$variable <-  factor(pov_level_spending_melt$variable, levels=c("avgrev", "avgspend"), labels=c("Revenue", "Spending"))

pov_level_spending_melt$poverty_level <- factor(pov_level_spending_melt$poverty_level, levels=c("very low", "low", "medium", "high", "very high"))




fill <-  c("#5F9EA0", "#E1B378")

g1 <-  ggplot(pov_level_spending_melt, aes(x=poverty_level, y=value, fill=variable)) + 
  geom_bar(stat='identity', position='dodge')+
  theme(legend.position="bottom", legend.direction="horizontal", legend.title=element_blank())+
  scale_fill_manual(values=fill)+
  theme_hc()+
      labs(title = "Revenue vs spending 2017-18", 
       subtitle = "Per adjusted count",
       caption = "Graphic by MaryJo Webster")



plot(g1)
```

#Minneapolis Public Schools
```{r}
match2018 %>% filter(revenue>0, district_number=='0001', district_type=='03') %>% group_by(poverty_level) %>% summarise(avgrev= mean(rev_per_need),avgspend = mean(spend_per_need), numschools=n())%>% mutate(pct=avgspend/avgrev)
```
#Total generated and spent by MPS
```{r}
match2018 %>% filter(district_number=='0001', district_type=='03') %>% 
  summarise(rev=sum(revenue), spen=sum(tot_spent)) %>% mutate(pct=spen/rev)
```

#DULUTH
```{r}
match2018 %>% filter(revenue>0, district_name=='DULUTH PUBLIC SCHOOL DISTRICT') %>% group_by(poverty_level) %>% summarise(avgrev= round_half_up(mean(rev_per_need)),avgspend = round_half_up(mean(spend_per_need)), numschools=n()) %>% mutate(pct=avgspend/avgrev)
```



#St. Paul Schools
```{r}
match2018 %>% filter(revenue>0, district_name=='ST. PAUL PUBLIC SCHOOL DISTRICT') %>% group_by(poverty_level) %>% summarise(avgrev= round_half_up(mean(rev_per_need)),avgspend = round_half_up(mean(spend_per_need)), numschools=n()) %>% mutate(pct=avgspend/avgrev)
```


```{r}
match2018 %>% filter(district_number=='0625', district_type=='01') %>% 
  summarise(rev=sum(revenue), spen=sum(tot_spent)) %>% mutate(pct=spen/rev)
```


#By Location- high poverty schools
```{r}
match2018 %>% filter(revenue>0, tot_spent>0, poverty_level=='high') %>% group_by(location) %>% summarise(avgrev= mean(rev_per_need),avgspend = mean(spend_per_need), numschools=n())
```

#By Location - low poverty schools
```{r}
match2018 %>% filter(revenue>0, tot_spent>0, poverty_level=='low') %>% group_by(location) %>% summarise(avgrev= round_half_up(mean(rev_per_need)),avgspend = round_half_up(mean(spend_per_need)), numschools=n())
```

#Minneapolis- specific schools
```{r}
match2018 %>% filter(revenue>0, district_number=='0001', district_type=='03') %>% 
  select(site_name, diff, adjusted_count,revenue, grades2, tot_spent, need_level, number_in_need, rev_per_need, spend_per_need ) %>%
  arrange(diff)
```


```{r}
match2018 %>% filter(spend_per_need>50000)

special %>% filter(schoolid=='0011-01-812', schoolyr==2018)
```


```{r}
windowsFonts(Arial=windowsFont("TT Arial")) 

scatter_data <- match2018 %>% filter(revenue>0, tot_spent>0, adjusted_count>0,schoolid!='0011-01-812', schoolid!='2906-01-010') %>% select(schoolid,poverty_level, rev_per_need, spend_per_need) %>% mutate(rev_per_need_round= round_half_up(rev_per_need), spend_per_need_round=round_half_up(spend_per_need))
                                                                                            

scatter1 <- ggplot(scatter_data, aes(x = rev_per_need_round, y = spend_per_need_round)) +
  theme_minimal(base_size = 14, base_family = "Arial") + 
  geom_point(size = 3, alpha = 0.5, aes(color=poverty_level)) +  #this is what makes it a scatterplot
  labs(title = "Revenue vs spending per pupil", 
       subtitle = "Source: Minnesota Department of Education",
       caption = "Graphic by MaryJo Webster",
       x="Revenue per pupil",
       y="Spending per pupil")

plot(scatter1)
```


#By school type
```{r}


match2018 %>% filter(revenue>0, tot_spent>0) %>% group_by(school_type) %>% summarise(avgrev= round_half_up(mean(rev_per_need)),avgspend = round_half_up(mean(spend_per_need)), numschools=n(), avgdiff = mean(diff)) %>% arrange(desc(avgspend))
```

```{r}
match2018 %>% filter(diff>2000, tot_spent>0) %>% select(school_name, school_type, revenue, tot_spent, poverty_level, rev_per_need, spend_per_need, diff) %>% arrange(diff)
```


#Metro districts spending more than revenue
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, metro7county=='yes') %>% group_by(district_name) %>%
  summarise(rev=mean(rev_per_need), spen= mean(spend_per_need), dif=mean(diff)) %>% 
  arrange(dif)
```

#anoka-hennepin
```{r}
match2018 %>% filter(district_name=='ANOKA-HENNEPIN PUBLIC SCHOOL DIST.', tot_spent>0) %>% select(school_name, school_type, revenue, tot_spent, poverty_level, rev_per_need, spend_per_need, diff) %>% arrange(diff)
```

#Metro schools spending less than 50% of what they generate
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, metro7county=='yes') %>% select(school_name, district_name, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
  filter(pct_of_rev<.5)%>% kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#This is an indicator that something is wrong with UFARS data
```{r}
match2018 %>% filter(district_name=='HIAWATHA ACADEMIES') %>% select(district_number, school_name, district_name, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev)  %>% kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

```{r}
ufars06_18 %>% filter(yr==2018, districtnum=='4170') %>% group_by(organization) %>% summarise(tot=sum(tot_amt))
```

```{r}
ufars06_18 %>% filter(yr==2018, districtnum=='4170') %>% summarise(tot=sum(tot_amt))
```

```{r}
revenue %>% filter(yr==2018, district_number=='4170') %>% summarise(rev=sum(revenue))
```



#Burnsville
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='BURNSVILLE PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Mounds View
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='MOUNDS VIEW PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Duluth
```{r}
duluth <- match2018 %>% filter(tot_spent>0, revenue>0, district_name=='DULUTH PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) 

#write.csv(duluth, 'duluth.csv', row.names=FALSE)


match2018 %>% filter(tot_spent>0, revenue>0, district_name=='DULUTH PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Bloomington
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='BLOOMINGTON PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Minneapolis
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='Minneapolis Public School District') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#St Paul
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='ST. PAUL PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

organization code 005 is district wide
<br>
these records won't be in match2018
```{r}
ufars06_18 %>% filter(organization=='005', yr==2018) %>% group_by(districtnum, disttype) %>% summarise(spend_total=round(sum(tot_amt),0))
```

#Minneapolis by site number
005=district level

```{r}
ufars06_18 %>% filter(yr=='2018', districtnum=='0001', disttype=='03') %>% group_by(organization) %>% summarise(spend_total=round(sum(tot_amt),0)) %>%
   arrange(organization)
```

#number of site_numbers in revenue file 
doesn't match number of organization numbers in ufars
```{r}
match2018 %>% filter(district_number=='0001', district_type=='03', yr==2018) %>% group_by(site_number) %>% summarise(rev=sum(revenue), count=n()) %>% arrange(site_number)
```


#Schools spending  more than 150% of what they generated
```{r}
match2018 %>% filter(tot_spent>0, revenue>0) %>% select(school_name, district_name, poverty_level,  revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% filter(pct_of_rev>1.5) %>% 
  arrange(desc(pct_of_rev)) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```
#Minnetonka
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='MINNETONKA PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Red Lake 
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_number=='0038') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2)) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Robbinsdale
```{r}
match2018 %>% filter(tot_spent>0, revenue>0, district_name=='ROBBINSDALE PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Alexandria 
aLL of the money is spent at the district level
```{r}
match2018 %>% filter(district_name=='ALEXANDRIA PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Elk River
```{r}
match2018 %>% filter(district_name=='ELK RIVER PUBLIC SCHOOL DISTRICT') %>% select(school_name, poverty_level, rev_per_need, spend_per_need, revenue, tot_spent) %>% mutate(pct_of_rev = round(as.double(tot_spent/revenue),2),
                                                                                                                      pct_of_district_total = (tot_spent/sum(tot_spent))) %>% arrange(pct_of_rev) %>% 
   kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```




#Total spending by program (with ELL)
```{r}

ufars06_18 %>% filter( yr==2018) %>%
  group_by(sub_group) %>% summarise(tot_spent=sum(tot_amt)) %>% 
    mutate(pct=(tot_spent/sum(tot_spent)*100)) %>% 
  arrange(desc(tot_spent))
  

```

#Total spending by program (without ELL)

```{r}
ufars06_18 %>% filter( yr==2018, program!='219') %>%
  group_by(sub_group) %>% summarise(tot_spent=sum(tot_amt)) %>% 
  mutate(pct=(tot_spent/sum(tot_spent)*100)) %>% 
  arrange(desc(tot_spent))
```

#Total spent by year (including ELL)
```{r}
ufars06_18%>% group_by(yr) %>% summarise(tot_spent=sum(tot_amt))
```

#Total generated by year
```{r}
revenue %>% group_by(yr) %>% summarise(tot_rev=sum(revenue))
```


#districts spending Basic Skills on extra-curriculars
```{r}



ufars06_18 %>%  filter(sub_group=='extra-curriculars', yr==2018) %>% group_by(district_name) %>% summarise(tot=sum(tot_amt))
```




#Red Lake

```{r}
ufars06_18 %>% filter(districtnum=='0038', yr==2018) %>% group_by(sub_group) %>% summarise(tot=sum(tot_amt)) %>%
    mutate(pct=(tot/sum(tot)*100)) %>% 
  arrange(desc(tot))
  
```

#St Paul schools
```{r}
ufars06_18 %>% filter(districtnum=='0625', yr==2018) %>% group_by(sub_group) %>% summarise(tot=sum(tot_amt)) %>%
    mutate(pct=(tot/sum(tot)*100)) %>% 
  arrange(desc(tot))
  
```

#charter schools
```{r}
ufars06_18 %>% filter(disttype=='07', yr==2018) %>% group_by(sub_group) %>% summarise(tot=sum(tot_amt)) %>%
    mutate(pct=(tot/sum(tot)*100)) %>% 
  arrange(desc(tot))
```

#Traditional districts
```{r}
ufars06_18 %>% filter(disttype=='01' | disttype=='03', yr==2018) %>% group_by(sub_group) %>% summarise(tot=sum(tot_amt)) %>%
    mutate(pct=(tot/sum(tot)*100)) %>% 
  arrange(desc(tot))
```



#district revenue vs spending 2018
```{r}
ufars_by_district <- ufars06_18 %>%
  filter(yr==2018, disttype=='01' | disttype=='03') %>%
  group_by(districtid) %>%
  summarise(spending=sum(tot_amt))

rev_by_district <-  revenue %>% filter(yr==2018, district_type=='01' | district_type=='03') %>% 
  group_by(districtid, district_name) %>% summarise(rev=sum(revenue), poverty_students=sum(adjusted_count))


district2018 <-  inner_join(rev_by_district, ufars_by_district, by=c("districtid"="districtid"))


ufars_district_005 <-  ufars06_18 %>% filter(program!='219', yr==2018, disttype=='01' | disttype=='03', organization=='005') %>%
  group_by(districtid) %>% summarise(spend_005 = sum(tot_amt))


district2018 <-  left_join(district2018, ufars_district_005, by=c("districtid"="districtid"))

district2018 <-  district2018 %>% mutate(pct=as.double(case_when(spend_005>0~spend_005/spending, TRUE~0)))

district2018 <-  district2018 %>% mutate(diff = as.double(rev)-as.double(spending),
                                         pctspent = spending/rev)



#money allocated to "tuition billing sites"
ufars06_18 %>% filter(organization=='998') %>% group_by(yr) %>% summarise(tuition_billing=sum(tot_amt))
```


#charter districts revenue vs spending 2018
```{r}
ufars_charters <- ufars06_18 %>%
  filter(yr==2018, disttype=='07') %>%
  group_by(districtid) %>%
  summarise(spending=sum(tot_amt))

rev_charters <-  revenue %>% filter(yr==2018, district_type=='07') %>% 
  group_by(districtid, district_name) %>% summarise(rev=sum(revenue), poverty_students=sum(adjusted_count))


charters2018 <-  inner_join(rev_charters, ufars_charters, by=c("districtid"="districtid")) %>% mutate(diff = as.double(rev)-as.double(spending), pctspent = spending/rev)
```



#spending by district by program category
```{r}
district_program_2018 <-  ufars06_18 %>% filter(yr==2018) %>% group_by(districtid, district_name, sub_group) %>% summarise(total_spent=sum(tot_amt))

district_program_2018_cast <- dcast(district_program_2018, districtid+district_name ~ sub_group) %>% clean_names

#names(district_program_2018_cast)

district_program_2018_cast$administration[is.na(district_program_2018_cast$administration)] <- 0
district_program_2018_cast$community_education[is.na(district_program_2018_cast$community_education)] <- 0
district_program_2018_cast$district_support_services[is.na(district_program_2018_cast$district_support_services)] <- 0
#district_program_2018_cast$ell[is.na(district_program_2018_cast$ell)] <- 0
district_program_2018_cast$extra_curriculars[is.na(district_program_2018_cast$extra_curriculars)] <- 0
district_program_2018_cast$instruction[is.na(district_program_2018_cast$instruction)] <- 0
district_program_2018_cast$instructional_support_services[is.na(district_program_2018_cast$instructional_support_services)] <- 0
district_program_2018_cast$pupil_support_services[is.na(district_program_2018_cast$pupil_support_services)] <- 0
district_program_2018_cast$special_education[is.na(district_program_2018_cast$special_education)] <- 0

district_program_2018_cast <-  district_program_2018_cast %>% mutate(total = district_program_2018_cast$administration+ district_program_2018_cast$community_education+ district_program_2018_cast$district_support_services+  district_program_2018_cast$extra_curriculars + district_program_2018_cast$instruction + district_program_2018_cast$instructional_support_services+ district_program_2018_cast$pupil_support_services + district_program_2018_cast$special_education,
                                                                     pct_special_ed = special_education/total)


```

#Pct spent on special education
```{r}
district_program_2018_cast %>% select(district_name, total, pct_special_ed) %>% arrange(desc(pct_special_ed))
```


#Pct spent on administration
```{r}
district_program_2018_cast %>% select(district_name, total, administration) %>%
  mutate(pct_admin = administration/total) %>% 
  arrange(desc(pct_admin))
```

#Pct spent on pupil support services
```{r}
district_program_2018_cast %>% select(district_name, total, pupil_support_services) %>%
  mutate(pct_pupil_support = pupil_support_services/total) %>% 
  arrange(desc(pct_pupil_support))
```





#Low poverty districts more likely to spend money on special ed
```{r}
district_program_2018_cast <-  left_join(district_program_2018_cast, special_district %>% select(districtid, poverty_level),by=c("districtid"="districtid"))

district_program_2018_cast %>% group_by(poverty_level) %>% summarise(speced=sum(special_education), tot=sum(total)) %>% mutate(pct_spec= speced/tot)

```


#Money spendingg by poverty level of district
```{r}
district_program_2018 <-  left_join(district_program_2018, special_district %>% select(districtid, poverty_level),by=c("districtid"="districtid"))

district_program_2018$poverty_level <- factor(district_program_2018$poverty_level, levels=c("very low", "low", "medium", "high", "very high"))

  district_program_2018%>% tabyl(sub_group, poverty_level)%>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_title("top")%>%
  knitr::kable("html") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
  
```



```{r}
revenue2018 %>% group_by(district_type) %>% summarise(tot_rev=sum(revenue))
```

```{r}
ufars2018 %>% group_by(disttype) %>% summarise(spent= sum(tot_spent))
```




```{r}



#write.csv(dist_match_allyrs, 'dist_match.csv', row.names=FALSE)
```
```{r}






dist_match_allyrs %>% filter(yr==2018, scope=='over by 15% or more'| scope=='under by 15% or more') %>% group_by(size, location, poverty_level) %>% summarise(count=n())

districts_to_call <-  dist_match_allyrs %>%
  filter(yr==2018)

write.csv(dist_match_allyrs, 'dist_match.csv', row.names=FALSE)

write.csv(districts_to_call, 'districts_to_call.csv', row.names = FALSE)
```


```{r}
dist_match_allyrs %>%
  filter(yr==2018, scope=='over by 15% or more' ) %>% 
  select(district_name, pct, rev, diff) %>% 
  arrange(desc(pct))
```



```{r}
  dist_match_allyrs%>% tabyl(yr, scope)%>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_title("top")%>%
  knitr::kable("html") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```


```{r}


```

