---
title: "poverty_concentrations"
author: "MaryJoWebster"
date: "January 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r}

library(readr) #importing csv files
library(dplyr) #general analysis 
library(ggplot2) #making charts
library(lubridate) #date functions
library(reshape2) #use this for melt function to create one record for each team
library(tidyr)
library(janitor) #use this for doing crosstabs
library(scales) #needed for stacked bar chart axis labels
library(knitr) #needed for making tables in markdown page
library(htmltools)#this is needed for Rstudio to display kable and other html code
library(rmarkdown)
library(kableExtra)
library(ggthemes)

library(RMySQL)
library(readxl) #for importing Excel files
library(DT) #needed for making  searchable sortable data tble
library(waffle)
library(foreign) #for importing SPSS files
library(jsonlite) #for exporting JSON
library(car)
library(aws.s3) #for loading to AWS server
library(getPass)


```

```{r}
con <- dbConnect(RMySQL::MySQL(), host = Sys.getenv("host"), dbname="Schools",user= Sys.getenv("userid"), password=Sys.getenv("pwd"))

#list the tables in the database we've connected to
#dbListTables(con)

#list the fields in the table; change "mytablename" to the name of the table you're trying to connect to
#dbListFields(con,'mytablename')


#Pull selected data using query inside the parentheses
data1 <- dbSendQuery(con, "select a.datayear, a.schoolid, a.districtnumber, a.districttype, b.DistrictName, b.SchoolName, b.Location, b.Metro7county, a.SchoolClassification,
b.SchoolType, a.K12Enr, a.FreeK12, a.RedK12
from enroll_special a left join SchoolList b on a.schoolid=b.schoolid
where a.grade='All grades' and (a.districttype='01' or a.districttype='03' or a.districttype='07' or a.districttype='06')")

#assign it to a new data frame
enroll_special <- fetch(data1, n=-1)

dbClearResult(data1)




data2 <- dbSendQuery(con, "select * from DistrictList")
districtlist <- fetch(data2, n=-1)

dbClearResult(data2)
						   

#(after pulling in all tables add this)
#disconnect connection
dbDisconnect(con)

rm(data1)
rm(data2)


#pull in a file that has classification codes for old schools
#need this to fill in some blanks in the data
add_classification <- read_csv("add_classification.csv", col_types=cols(.default="c"))

```
```{r}

#join enroll data to the districtlist to grab location information 
enroll_special_2 <-  inner_join(enroll_special, districtlist %>% select(DistrictNumber, DistrictType,Metro7County, Location), by=c("districtnumber"="DistrictNumber", "districttype"="DistrictType"))


#filter out the schools without any enrollment in a given year
#add column that merges location information where it was blank in teh enrollment data, it pulls from district list data
#winnow down the columns to include in this table
enroll_special_2 <- enroll_special_2 %>% filter(K12Enr!="NA", K12Enr>0) %>% 
  mutate(location_new=case_when(is.na(Location.x)~Location.y, TRUE~Location.x)) %>% 
  select(datayear, schoolid, districtnumber, districttype, DistrictName, SchoolName, SchoolClassification, SchoolType,
         K12Enr, FreeK12,RedK12, location_new )

#add poverty columns
#this counts reduced-price kids as .5 and free lunch kids as 1 (the formula the state uses for Basic Skills)
enroll_special_2 <- enroll_special_2 %>% mutate(poverty=(RedK12*.5)+FreeK12,pctpoverty=poverty/K12Enr)


#This joins  enroll data to that classification file and creates a new dataframe
enroll_special_3 <-  inner_join(enroll_special_2, add_classification %>% select(schoolid, Classification), by=c("schoolid"="schoolid"))

#This populations a classcode field with a classification number, either from the enroll data or (where missing) from the classifcation data frame
enroll_special_3 <-  enroll_special_3 %>% mutate(classcode=case_when(is.na(SchoolClassification)~Classification, TRUE~SchoolClassification)) %>% select(datayear, schoolid, districtnumber, districttype, DistrictName,
                                                                                                                                                        SchoolName, classcode, SchoolType,K12Enr, FreeK12, RedK12, location_new, poverty, pctpoverty)


```

```{r}

#This updates the SchoolType field according to that new classcode
#I've chosen to group some of the categories together to avoid having small buckets

enroll_special_3$SchoolType[enroll_special_3$classcode=='10'] <- 'Elementary'
enroll_special_3$SchoolType[enroll_special_3$classcode=='20'] <- 'Middle/Junior High'
enroll_special_3$SchoolType[enroll_special_3$classcode=='31'] <- 'Middle/Junior High'
enroll_special_3$SchoolType[enroll_special_3$classcode=='32'] <- 'Secondary/Senior High'
enroll_special_3$SchoolType[enroll_special_3$classcode=='33'] <- 'Secondary/Senior High'
enroll_special_3$SchoolType[enroll_special_3$classcode=='40'] <- 'Elementary/Secondary Combo'
enroll_special_3$SchoolType[enroll_special_3$classcode=='41'] <- 'ALC/ALP/Private'
enroll_special_3$SchoolType[enroll_special_3$classcode=='42'] <- 'ALC/ALP/Private'
enroll_special_3$SchoolType[enroll_special_3$classcode=='43'] <- 'ALC/ALP/Private'
enroll_special_3$SchoolType[enroll_special_3$classcode=='46'] <- 'Distance Learning'
enroll_special_3$SchoolType[enroll_special_3$classcode=='50'] <- 'Special Education'
enroll_special_3$SchoolType[enroll_special_3$classcode=='71'] <-  'Hospital/Medical/Treatment/Misc'
enroll_special_3$SchoolType[enroll_special_3$classcode=='74'] <- 'Hospital/Medical/Treatment/Misc'
enroll_special_3$SchoolType[enroll_special_3$classcode=='77'] <- 'Hospital/Medical/Treatment/Misc'
enroll_special_3$SchoolType[enroll_special_3$classcode=='79'] <- 'Hospital/Medical/Treatment/Misc'
```

```{r}
#add column that identifies whether school has a high concentration of poverty



```

```{r}

```

