---
title: "basic_skills_analysis"
author: "MaryJoWebster"
date: "February 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, code=readLines("build_data.R"), echo=FALSE, warning=FALSE, message=FALSE}


```

#Money generated, poverty students per year
```{r}
df %>% filter(revenue>0) %>%  group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
  
```






```{r}
peryear <-  df %>% filter(revenue>0) %>%  group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% mutate(perstudent=rev/atrisk_students, millions=rev/1000000)

peryear_chart <- ggplot(peryear, aes(x = yr, y = perstudent)) +
    geom_bar(stat = "identity", color="#59A897", fill="#59A897") +
    #geom_text(stat="identity", label=paste0((peryear$perstudent)), hjust= -0.5, size=3,                       position= position_dodge(width=1))+
    #coord_flip() +     #this makes it a horizontal bar chart instead of vertical
    theme_hc()+
  scale_y_continuous(limits=c(0, 2000))+
  scale_x_continuous(name="School year", breaks=seq(2007, 2018, 2))+

    labs(title = "Revenue generated per at-risk student", 
       subtitle = "2006-2018",
       caption = "Graphic by MaryJo Webster",
       x="Year",
       y="Revenue per student")

plot(peryear_chart)
```

```{r}


totrev_chart <- ggplot(peryear, aes(x = yr, y = millions)) +
    geom_bar(stat = "identity", color="#59A897", fill="#59A897") +
    #geom_text(stat="identity", label=paste0((peryear$perstudent)), hjust= -0.5, size=3,                       position= position_dodge(width=1))+
    #coord_flip() +     #this makes it a horizontal bar chart instead of vertical
    theme_hc()+
  scale_y_continuous(limits=c(0, 700))+
  scale_x_continuous(name="School year", breaks=seq(2006, 2018, 2))+

    labs(title = "Total revenue generated (in millions)", 
       subtitle = "2006-2018",
       caption = "Graphic by MaryJo Webster",
       x="Year",
       y="Revenue per student (millions)")

plot(totrev_chart)
```

#Revenue generated By district type (2018 only)
```{r}
df %>% filter(yr==2018, revenue>0) %>% group_by(district_type) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Metro area - by district type (2018)
```{r}
df %>% filter(yr==2018, revenue>0, metro7county=='yes') %>% group_by(district_type) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```



#Revenue generated By school type (2018 only)
```{r}
df %>% filter(yr==2018, revenue>0) %>% group_by(school_type) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Revenue by location (2018 only)
```{r}
df %>% filter(yr==2018, revenue>0) %>% group_by(location) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Core cities, 2018, by district type
01=St. Paul<br>
03=Minneapolis<br>
07=All charter schools in the core cities
```{r}
df %>% filter(yr==2018, revenue>0, location=='CORE CITIES') %>% group_by(district_type) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Core cities, 2007
```{r}
df %>% filter(yr==2007, revenue>0, location=='CORE CITIES') %>% group_by(district_type) %>% summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count)) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(desc(perstudent))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```


#Districts generating the most per student

```{r}
df %>% filter(yr==2018) %>%  group_by(district_name) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% 
  mutate(perstudent=rev/atrisk_students) %>% 
  filter(perstudent>3209) %>% 
  arrange(desc(perstudent), desc(rev))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Hiawatha Academies

```{r}
df %>% filter(district_name=='HIAWATHA ACADEMIES') %>% group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% 
  mutate(perstudent=rev/atrisk_students) %>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Higher Ground Academy
```{r}
df %>% filter(district_name=='HIGHER GROUND ACADEMY') %>% group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% 
  mutate(perstudent=rev/atrisk_students) %>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```
#Minneapolis
```{r}
df %>% filter(districtid=='0001-03-000') %>% group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% 
  mutate(perstudent=rev/atrisk_students) %>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```
#St. Paul
```{r}
df %>% filter(districtid=='0625-01-000') %>% group_by(yr) %>% summarise(rev=sum(revenue), atrisk_students=sum(adjusted_count)) %>% 
  mutate(perstudent=rev/atrisk_students) %>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```


#Number of schools generating revenue
9% increase since 2006-07<br>
(in 17-18 there were 2,294 total schools)
```{r}
df%>% filter(revenue>0) %>% group_by(yr) %>% summarise(numschools=n(), avg=mean(revenue))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#total schools in the state
(largely unchanged)
```{r}
race %>% group_by(schoolyr) %>% summarise(numschools=n())%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```





#Traditional districts generating revenue (type=01 or 03)
```{r}

df %>% filter(district_type=='01' | district_type=='03') %>% group_by(yr) %>% 
  summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count), numschools=n()) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(yr)%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```




#charter schools generating revenue
```{r}

df %>% filter(district_type=='07') %>% group_by(yr) %>% 
  summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count), numschools=n()) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(yr)%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```




#Non-traditional districts(excluding charters)
Special education, intermediate districts, correctional, coops
```{r}
df %>% filter(district_type %in% c("06", "08", "35", "50", "51", "52", "53", "61", "62", "70", "83")) %>% group_by(yr) %>% 
  summarise(rev=round(sum(revenue),0), at_risk_students=sum(adjusted_count), numschools=n()) %>%
  mutate(perstudent=rev/at_risk_students) %>% arrange(yr)%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```



#Average concentration
```{r}
df %>% group_by(yr) %>% summarise(avg_conc= mean(concentration))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Number of schools with poverty concentration >=80%
In the Core Cities
```{r}
df %>% filter(concentration>=.8, location=='CORE CITIES') %>% group_by(yr) %>% summarise(count=n(), students=sum(adjusted_count))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Schools with high poverty, suburbs
```{r}
df %>% filter(concentration>=.8, location=='SUBURBS') %>% group_by(yr) %>% summarise(count=n(), students=sum(adjusted_count), avg_rev=mean(revenue))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```

#Charter schools with high poverty concentrations
```{r}
df %>% filter(concentration>=.8, district_type=='07') %>% group_by(yr) %>% summarise(count=n(), students=sum(adjusted_count))%>%  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position="left")
```


Are there districts/schools that have an achievement gap problem now that didn't in the past? (due to influx of poor kids?)


